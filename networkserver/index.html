<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Network Server - The Things Network</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>
        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">The Things Network</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Overview</a>
                </li>
            
            
            
                <li >
                    <a href="../common/">Common</a>
                </li>
            
            
            
                <li >
                    <a href="../router/">Router</a>
                </li>
            
            
            
                <li >
                    <a href="../broker/">Broker</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Network Server</a>
                </li>
            
            
            
                <li >
                    <a href="../handler/">Handler</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../broker/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../handler/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    
    <table>
        <tr><td>version:</td><td>1.0.0</td></tr>
        <tr><td>status:</td><td>draft</td></tr>
        <tr><td>lead:</td><td>Matthias Benkort</td></tr>
        <tr><td>collaborators:</td><td>
            
                Johan Stokking<br/>
            
                Hylke Visser<br/>
            
                Thomas Telkamp<br/>
            
        </td></tr>
    </table>

    <hr/>
    

    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#network-server">Network Server</a></li>
        
            <li><a href="#role">Role</a></li>
        
            <li><a href="#interfaces">Interfaces</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="network-server">Network Server</h1>
<table>
<thead>
<tr>
<th>NS</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>NS-1</td>
<td>Handle commands from a broker</td>
</tr>
<tr>
<td>NS-2</td>
<td>Monitor the network</td>
</tr>
<tr>
<td>NS-3</td>
<td>Emit commands to a broker</td>
</tr>
<tr>
<td>NS-4</td>
<td>Handle OTAA &amp; new node</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>NS-1.1</td>
<td>Listen and receive incoming command messages</td>
</tr>
<tr>
<td>NS-1.2</td>
<td>Identify related command</td>
</tr>
<tr>
<td>NS-1.3</td>
<td>Execute command</td>
</tr>
<tr>
<td>NS-1.4</td>
<td>Reply if necessary with another command</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>//TODO</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="role">Role</h2>
<p>A network server is a component dedicated to the network management. It handle the required
logic to handle and to emit MAC commands (more precisions about MAC commands are given below).
Basically, a network server is composed of two parts:</p>
<ul>
<li>a core logic</li>
<li>a data storage</li>
</ul>
<p>The former interprets commands sent by nodes, forwarded by routers and brokers, combine them
with data stored in the latter in order to give an appropriate answer. The main usecase of the
network server will concern the adaptive data rate (<em>ADR</em>) control detailed in the <a href="https://www.lora-alliance.org/portals/0/specs/LoRaWAN%20Specification%201R0.pdf">LoRaWAN
specifications 1.0</a> - section 4.3.1.1 Adaptive data rate control in frame header. </p>
<p>In order to keep the network highly reactive, we'll adopt an in-memory storage. The network
server will make sure data are persisted regularly in order to both prevent from small
disruptions and recover from an existing state after an update or a maintainance activity.</p>
<p>A network server is associated to a broker. The broker is forwarding, queuing and dispatching
packets whereas the network server interprets them when necessary. Because a network server is
only having interactions with a dedicated broker, the set broker + network server could be
seen as one unique component with a bigger but well-defined set of responsibilities. This
also implies that a given network server only has one and only one correspondent. There is no
transversal communication between network servers. The storage isn't distributed over the
network but rather fragmented over it. </p>
<p><span class="label label-info">discussion</span>   </p>
<blockquote>
<p>In future versions, it could be nice for reliability to make data of network servers
accessible from anywhere in the network. This nevertheless raises an issue about
confidentiality and confidence over all network constituents. </p>
</blockquote>
<p>Besides, the network server has also an active role during an over-the-air activation (join
request) from a node: it allocates a new randomly generated device address. Because node
addresses within the network are 24 bits length, there is 100% chances to allocate the same
address to two differents nodes after more or less 5500 allocations. However, all packets also
carry a MIC number, and thus there is still a way for the network to clearly identify a node
without any risk of collision. </p>
<h3 id="mac-commands">MAC Commands</h3>
<p>There is a set of fourteen (in fact, 7 commands and 7 acknowledgements) MAC commands that will
transit over the network and with which it should be compliant. A MAC command materialize an
exchange between the network (via the network server) and the MAC layer of an env-device. This
means that those commands are invisible for the application server registered to a handler, but
also for the one embedded on the device.
These commands serves the network internal management: </p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Transmitted by</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>LinkCheckReq</td>
<td>End-device</td>
<td>Used by an end-device to validate its connectivity to a network</td>
</tr>
<tr>
<td>LinkCheckAns</td>
<td>Network Server</td>
<td>Answer to LinkCheckReq command. Contains the received signal power estimation indicating to the end-device the quality of reception (link margin).</td>
</tr>
<tr>
<td>LinkADRReq</td>
<td>Network Server</td>
<td>Requests the end-device to change data rate, transmit power, repetition rate or channel.</td>
</tr>
<tr>
<td>LinkADRAns</td>
<td>End-device</td>
<td>Acknowledges the LinkADRReq</td>
</tr>
<tr>
<td>DutyCycleReq</td>
<td>Network Server</td>
<td>Sets the maximum aggregated transmit duty-cycle of a device</td>
</tr>
<tr>
<td>DutyCycleAns</td>
<td>End-device</td>
<td>Acknowledges a DutyCycleReq command</td>
</tr>
<tr>
<td>RXParamSetupReq</td>
<td>Network Server</td>
<td>Sets the reception slots parameters</td>
</tr>
<tr>
<td>RXParamSetupAns</td>
<td>End-device</td>
<td>Acknowledges a RXParamSetupReq command</td>
</tr>
<tr>
<td>DevStatusReq</td>
<td>Network Server</td>
<td>Request the status of the end-device</td>
</tr>
<tr>
<td>DevStatusAns</td>
<td>End-device</td>
<td>Returns the status of the end-device, namely its battery level and its demodulation margin</td>
</tr>
<tr>
<td>NewChannelReq</td>
<td>Network Server</td>
<td>Creates or modifies the definition of a radio channel</td>
</tr>
<tr>
<td>NewChannelAns</td>
<td>End-device</td>
<td>Acknowledges a NewChannelReq command</td>
</tr>
<tr>
<td>RXTimingSetupReq</td>
<td>Network Server</td>
<td>Sets the timing of the reception slots</td>
</tr>
<tr>
<td>RXTimingSetupAns</td>
<td>End-device</td>
<td>Acknowledges a RXTimingSetupReq command</td>
</tr>
</tbody>
</table>
<p><em>The above table is extracted from the <a href="https://www.lora-alliance.org/portals/0/specs/LoRaWAN%20Specification%201R0.pdf">LoRaWAN specifications</a> - Section 5 MAC Commands.</em></p>
<p>Technically, only one "real" command is emitted by the node, the rest is only acknowledgement
and data transmission. Commands are mainly initiated by the network server and all of them are
detailed in the LoRaWan Specifications.</p>
<h3 id="communication-with-the-broker">Communication with the broker</h3>
<p>In practice, the network server and the broker are likely to be localised on the same physical
entity. However, in order to be able to scale easily in the future and to decouple those
components if needed, they will talk to each other through well defined interfaces. In the same
pattern we are using for any component, the network server will be divided in three
sub-components:</p>
<ul>
<li>The storage, that provides an interface to the core logic to store and retrieve stored data.</li>
<li>The core logic, which manages commands and trigger actions on the other sub components.</li>
<li>The broker adapter, which communicates with the broker and trigger action on the core logic
  when commands are forwarded by the broker.</li>
</ul>
<h2 id="interfaces">Interfaces</h2>
<h3 id="storage">Storage</h3>
<p>// TODO</p>
<h3 id="core">Core</h3>
<p>// TODO</p>
<h3 id="broker-adapter">Broker adapter</h3>
<p>// TODO</p></div>
        </div>

        
        <div id="disqus_thread" class="container"></div>
        <script type="text/javascript">
            var disqus_shortname = 'thethingsnetwork';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>